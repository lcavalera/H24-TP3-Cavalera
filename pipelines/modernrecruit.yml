# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- main

pool:
  vmImage: ubuntu-latest

variables:
  buildConfiguration: 'Release'
  serviceConnection: 'sc-azure'
  artifactName: 'drop'
  apps: [
    'documents',
    'emplois',
    'favoris',
    'postulations'
  ]

  stages:

  - stage: 'GenerationSolution'
    displyName: 'Generation Solution Modern Recruit'
    jobs:
    - template: templates/generation-template.yml
      parameters:
        buildConfiguration: $(buildConfiguration)

  - ${{each app in apps}}:
    - stage: 'Build'
      displayName: 'Build api ${{app}}'
      dependsOn: 'GenerationSolution'
      jobs:
      - template: templates/build-template.yml
        parameters:
          buildConfiguration: $(buildConfiguration)
          artifactName: 'artif-${{app}}'
          appname: '${{app}}.API'

  - stage: 'BuildMvc'
    displayName: 'Build MVC'
    dependsOn: 'GenerationSolution'
    jobs:
    - template: templates/build-template.yml
      parameters:
        buildConfiguration: $(buildConfiguration)
        artifactName: 'artif-MVC'
        appname: 'MVC'
        publishWebProjects: true

  - ${{each app in apps}}:
    - stage: 'DeployToDev'
      displayName: 'Deploy api ${{app}} to Dev'
      dependsOn:
      - 'Build'
      - 'BuildMvc'
      jobs:
      - template: templates/deploy-template.yml
        parameters:
          environment: 'Dev'
          artifactName: 'artif-${{app}}'
          serviceConnection: $(serviceConnection)
          webAppName: 'webapp-${{app}}-*'


  - stage: 'DeployMvc'
    displayName: 'Deploy MVC to Dev'
    dependsOn: 'DeployToDev'
    jobs:
    - template: templates/deploy-template.yml
      parameters:
        environment: 'Dev'
        artifactName: 'artif-MVC'
        serviceConnection: $(serviceConnection)
        webAppName: 'webapp-mvc-*'

  # - stage: 'EmploisDeployToDev'
  #   displayName: 'Build et Deploy API Emplois to Dev'

  #   jobs:
  #   - job: 'Build'
  #     template: templates/build-template.yml
  #     parameters:
  #       buildConfiguration: $(buildConfiguration)
  #       artifactName: $(artifactName)
  #       appname: 'Emplois.API'
  #       publishWebProjects: false

  #   - job: 'Deploy'
  #     template: templates/deploy-template.yml
  #     parameters:
  #       environment: 'Dev'
  #       artifactName: $(artifactName)
  #       serviceConnection: $(serviceConnection)
  #       webAppName: 'webapp-emplois-*'

  # - stage: 'FavorisDeployToDev'
  #   displayName: 'Build et Deploy API Favoris to Dev'

  #   jobs:
  #   - job: 'Build'
  #     template: templates/build-template.yml
  #     parameters:
  #       buildConfiguration: $(buildConfiguration)
  #       artifactName: $(artifactName)
  #       appname: 'Favoris.API'
  #       publishWebProjects: false

  #   - job: 'Deploy'
  #     template: templates/deploy-template.yml
  #     parameters:
  #       environment: 'Dev'
  #       artifactName: $(artifactName)
  #       serviceConnection: $(serviceConnection)
  #       webAppName: 'webapp-favoris-*'

  # - stage: 'PostulationsDeployToDev'
  #   displayName: 'Build et Deploy API Postulations to Dev'

  #   jobs:
  #   - job: 'Build'
  #     template: templates/build-template.yml
  #     parameters:
  #       buildConfiguration: $(buildConfiguration)
  #       artifactName: $(artifactName)
  #       appname: 'Postulations.API'
  #       publishWebProjects: false

  #   - job: 'Deploy'
  #     template: templates/deploy-template.yml
  #     parameters:
  #       environment: 'Dev'
  #       artifactName: $(artifactName)
  #       serviceConnection: $(serviceConnection)
  #       webAppName: 'webapp-postulations-*'
